name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
      issues: write

    services:
      redis:
        image: redis:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: JDK 17 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Gradle Wrapper ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      run: chmod +x gradlew

    - name: Gradle ìºì‹œ ì„¤ì •
      uses: gradle/actions/setup-gradle@v3

    - name: Gradle ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
      run: ./gradlew build test --no-daemon

    - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          build/test-results/
          build/reports/tests/
        if-no-files-found: ignore

    - name: ë¹Œë“œ ê²°ê³¼ ì—…ë¡œë“œ
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: build/libs/*.jar
        if-no-files-found: ignore

    - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½ ìƒì„±
      if: always()
      id: test-summary
      run: |
        echo "## ğŸ”¨ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "build/test-results/test/TEST-*.xml" ]; then
          # í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì‹±
          total=$(find build/test-results/test -name "*.xml" -exec grep -o 'tests="[0-9]*"' {} \; | sed 's/tests="//;s/"//' | awk '{s+=$1} END {print s}')
          failures=$(find build/test-results/test -name "*.xml" -exec grep -o 'failures="[0-9]*"' {} \; | sed 's/failures="//;s/"//' | awk '{s+=$1} END {print s}')
          errors=$(find build/test-results/test -name "*.xml" -exec grep -o 'errors="[0-9]*"' {} \; | sed 's/errors="//;s/"//' | awk '{s+=$1} END {print s}')
          skipped=$(find build/test-results/test -name "*.xml" -exec grep -o 'skipped="[0-9]*"' {} \; | sed 's/skipped="//;s/"//' | awk '{s+=$1} END {print s}')
          
          passed=$((total - failures - errors - skipped))
          
          echo "TESTS_TOTAL=$total" >> $GITHUB_OUTPUT
          echo "TESTS_PASSED=$passed" >> $GITHUB_OUTPUT
          echo "TESTS_FAILED=$((failures + errors))" >> $GITHUB_OUTPUT
          echo "TESTS_SKIPPED=$skipped" >> $GITHUB_OUTPUT
          
          echo "### âœ… í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- ì „ì²´: $total" >> $GITHUB_STEP_SUMMARY
          echo "- ì„±ê³µ: $passed" >> $GITHUB_STEP_SUMMARY
          echo "- ì‹¤íŒ¨: $((failures + errors))" >> $GITHUB_STEP_SUMMARY
          echo "- ê±´ë„ˆëœ€: $skipped" >> $GITHUB_STEP_SUMMARY
        else
          echo "TESTS_TOTAL=0" >> $GITHUB_OUTPUT
          echo "TESTS_PASSED=0" >> $GITHUB_OUTPUT
          echo "TESTS_FAILED=0" >> $GITHUB_OUTPUT
          echo "TESTS_SKIPPED=0" >> $GITHUB_OUTPUT
        fi
        
        # ë¹Œë“œ ê²°ê³¼ í™•ì¸
        if [ -f "build/libs/"*.jar ]; then
          jar_files=$(ls -lh build/libs/*.jar | awk '{print $9" ("$5")"}')
          echo "### ğŸ“¦ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$jar_files" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

    - name: PRì— ë¹Œë“œ ê²°ê³¼ ì½”ë©˜íŠ¸ ì‘ì„±
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const buildStatus = '${{ job.status }}';
          const testTotal = '${{ steps.test-summary.outputs.TESTS_TOTAL }}';
          const testPassed = '${{ steps.test-summary.outputs.TESTS_PASSED }}';
          const testFailed = '${{ steps.test-summary.outputs.TESTS_FAILED }}';
          const testSkipped = '${{ steps.test-summary.outputs.TESTS_SKIPPED }}';
          
          const statusEmoji = buildStatus === 'success' ? 'âœ…' : 'âŒ';
          const statusText = buildStatus === 'success' ? 'ì„±ê³µ' : 'ì‹¤íŒ¨';
          
          let comment = `## ${statusEmoji} ë¹Œë“œ ${statusText}\n\n`;
          comment += `**ì»¤ë°‹:** ${context.sha.substring(0, 7)}\n`;
          comment += `**ë¸Œëœì¹˜:** ${context.ref}\n`;
          comment += `**ì‹¤í–‰ ì‹œê°„:** ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}\n\n`;
          
          if (testTotal > 0) {
            const testPassRate = ((testPassed / testTotal) * 100).toFixed(1);
            comment += `### ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼\n\n`;
            comment += `| í•­ëª© | ê°œìˆ˜ |\n`;
            comment += `|------|------|\n`;
            comment += `| ì „ì²´ í…ŒìŠ¤íŠ¸ | ${testTotal} |\n`;
            comment += `| âœ… ì„±ê³µ | ${testPassed} |\n`;
            comment += `| âŒ ì‹¤íŒ¨ | ${testFailed} |\n`;
            comment += `| â­ï¸ ê±´ë„ˆëœ€ | ${testSkipped} |\n`;
            comment += `| ğŸ“Š ì„±ê³µë¥  | ${testPassRate}% |\n\n`;
          }
          
          comment += `### ğŸ“ ìƒì„¸ ì •ë³´\n\n`;
          comment += `- [ë¹Œë“œ ë¡œê·¸ í™•ì¸](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;
          comment += `- [í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ](${context.payload.repository.html_url}/actions/runs/${context.runId}#artifacts)\n`;
          
          if (buildStatus === 'success') {
            comment += `\nâœ¨ ë¹Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`;
          } else {
            comment += `\nâš ï¸ ë¹Œë“œ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

