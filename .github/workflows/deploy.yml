name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. 소스 체크아웃
    - name: Checkout
      uses: actions/checkout@v4

    # 2. JDK 17 설치
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 2-1. Gradle Wrapper 실행 권한 부여
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 2-2. Gradle 캐시 설정
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3

    # 3. 테스트 실행
    - name: Run tests
      run: ./gradlew test --no-daemon

    # 4. 빌드
    - name: Build
      run: ./gradlew clean build -x test

    # 5. EC2에 JAR 복사
    - name: Copy jar to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        source: "build/libs/*.jar"
        target: "/home/ec2-user/app"

    # 6. EC2에서 애플리케이션 재시작
    - name: Restart app on EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        script: |
          set -e
          cd ~/app

          echo "기존 앱 종료"
          pkill -f 'java -jar' || true
          sleep 2

          echo "최신 jar 실행"
          JAR_NAME=$(ls *.jar | head -n 1)
          nohup java -jar $JAR_NAME > app.log 2>&1 &

          echo "배포 완료"