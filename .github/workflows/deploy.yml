name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. 소스 체크아웃
    - name: Checkout
      uses: actions/checkout@v4

    # 2. JDK 17 설치
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 2-1. Gradle Wrapper 실행 권한 부여
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 2-2. Gradle 캐시 설정
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3

    # 3. 테스트 실행
    - name: Run tests
      run: ./gradlew test --no-daemon

    # 4. 빌드
    - name: Build
      run: ./gradlew clean build -x test

    # 5. EC2에 JAR 복사
    - name: Copy jar to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        source: "build/libs/*.jar"
        target: "/home/ec2-user/app"

    # 6. EC2에서 애플리케이션 재시작
    - name: Restart app on EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        script: |
          echo "========== 배포 시작 =========="
          cd ~/app/build/libs || exit 1

          echo "========== 기존 앱 종료 =========="
          # 현재 사용자의 Java 프로세스만 찾기
          OLD_PID=$(ps -u $(whoami) -f | grep "java.*redis-test.*\.jar" | grep -v grep | awk '{print $2}' | head -n 1)
          
          if [ -n "$OLD_PID" ] && [ "$OLD_PID" != "" ]; then
            echo "실행 중인 애플리케이션 발견 (PID: $OLD_PID)"
            echo "프로세스 정보:"
            ps -p $OLD_PID -o pid,cmd 2>/dev/null || echo "프로세스 정보 조회 실패"
            
            echo "종료 신호 전송 중..."
            if kill $OLD_PID 2>/dev/null; then
              echo "종료 신호 전송 성공"
            else
              echo "종료 신호 전송 실패 (권한 문제일 수 있음)"
            fi
            
            # 종료 대기 (최대 5초)
            for i in 1 2 3 4 5; do
              sleep 1
              if ! ps -p $OLD_PID > /dev/null 2>&1; then
                echo "✅ 애플리케이션 정상 종료됨"
                break
              fi
              echo "종료 대기 중... ($i/5)"
            done
            
            # 여전히 실행 중이면 강제 종료
            if ps -p $OLD_PID > /dev/null 2>&1; then
              echo "강제 종료 시도..."
              if kill -9 $OLD_PID 2>/dev/null; then
                echo "강제 종료 성공"
              else
                echo "⚠️ 강제 종료 실패"
              fi
              sleep 1
            fi
          else
            echo "실행 중인 앱 없음"
          fi
          echo "종료 처리 완료"

          echo "========== 디렉토리 내용 확인 =========="
          ls -la
          
          echo "========== JAR 파일 선택 =========="
          # plain.jar가 아닌 실행 가능한 JAR 파일 찾기
          if ls redis-test-*.jar 2>/dev/null | grep -v plain > /dev/null; then
            JAR_NAME=$(ls redis-test-*.jar | grep -v plain | head -n 1)
          else
            JAR_NAME=$(ls *.jar 2>/dev/null | head -n 1)
          fi
          
          if [ -z "$JAR_NAME" ]; then
            echo "❌ JAR 파일을 찾을 수 없습니다!"
            exit 1
          fi
          
          echo "실행할 JAR: $JAR_NAME"
          
          echo "========== 애플리케이션 시작 =========="
          nohup java -jar "$JAR_NAME" > ~/app/app.log 2>&1 &
          APP_PID=$!
          echo "애플리케이션 시작됨 (백그라운드 PID: $APP_PID)"
          
          sleep 3
          
          echo "========== 시작 확인 =========="
          if pgrep -f "redis-test.*\.jar" > /dev/null; then
            RUNNING_PID=$(pgrep -f "redis-test.*\.jar")
            echo "✅ 애플리케이션이 성공적으로 시작되었습니다!"
            echo "프로세스 ID: $RUNNING_PID"
          else
            echo "⚠️ 애플리케이션 시작 실패 - 로그를 확인하세요"
            if [ -f ~/app/app.log ]; then
              echo "--- 로그 마지막 20줄 ---"
              tail -20 ~/app/app.log
            else
              echo "로그 파일 없음"
            fi
            exit 1
          fi

          echo "========== 배포 완료 =========="